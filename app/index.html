<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link href="../node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<script>
  window.onerror = function(e) {
    alert('システムエラーが発生しました。\r\n管理者に問い合わせてください。\r\n\r\n' + e);
  };

  // Node.jsライブラリをインポートする
  const electron = require('electron');
  const fs = require("fs");
  const path = require("path");
  const child_process = require('child_process');
  const crypto = require('crypto');

  // サードパーティライブラリをインポートする
  window.jQuery = window.$ = require('jQuery');
  require('bootstrap');
  const iconv = require('iconv-lite');
  const yaml = require('js-yaml');
  const _7z = require('7zip')['7z'];

  const config = yaml.safeLoad(fs.readFileSync('medusa.yml', 'utf8'));

  $(function() {
    // イベントリスナ間の受け渡しオブジェクト (TODO:modal要素に持たせて閉じたらクリアするように変更する)
    var modalStatus;

    // イベントリスナを登録する
    $('#chooseFile, #chooseFolder').on('change', (event) => {
      modalStatus = { action: 'zip', srcFilePath: event.currentTarget.files[0].path };
      event.currentTarget.value = ''; // 同じものを再度対象にしたときもchangeイベントが走るようにクリアする
      $('#modalPassword').modal('show');
    });
    $("#openHistory").on('click', () => {
      modalStatus = { action: 'history' };
      $('#modalPassword').modal('show');
    });
    $("#openSettings").on('click', () => {
      alert('Will open modal to set zip/unzip application path');
    });
    $('#close').on('click', () => {
      electron.remote.getCurrentWindow().close();
    });

    // modal系イベントリスナを登録する
    $('.modal').on('shown.bs.modal', () => {
      $(this).find('input[type="password"]').first().focus(); // modal要素が開いたらパスワードにフォーカス
    }).on('hidden.bs.modal', () => {
      $(this).find('input[type="password"]').val(''); // modal要素が閉じたらパスワードをクリア
      $('#passwordInputGroup').removeClass('has-success'); // パスワード一致の色も消しておく
    });
    $('#password').on('keypress', (event) => {
      if (event.keyCode === 13) $('#enterPassword').click();
    }).on('keyup', () => {
      const password = $('#password').val(); // thisでは取れないので検索し直す
      if (toHash(password) === config.latestHash) {
        // 最新パスワードと一致した場合は色で知らせる
        $('#passwordInputGroup').addClass('has-success');
      } else {
        $('#passwordInputGroup').removeClass('has-success');
      }
    });
    $('#enterPassword').on('click', () => {
      const inputPassword = $('#password').val();
      if (modalStatus.action === 'zip') {
        if (/(.+)\.zip/.test(modalStatus.srcFilePath)) {
          const destFilePath = RegExp.$1;
          var passwordHistory;
          try {
            passwordHistory = decryptHistory(config.cryptedHistory, inputPassword);
          } catch(e) {
            passwordHistory = [inputPassword]; // 最新パスワードと一致しなくても、入力されたパスワードで解凍しに行く
          }
          unzip(modalStatus.srcFilePath, destFilePath, passwordHistory);
        } else {
          zip(modalStatus.srcFilePath);
        }
      } else if (modalStatus.action === 'history') {
        const table = $('#passwordHistory').empty(); // TODO:履歴モーダルを閉じた時点で消しておきたい情報
        var passwordHistory;
        try {
          passwordHistory = decryptHistory(config.cryptedHistory, inputPassword);
        } catch(e) {
          alert('パスワードが違います');
          return null;
        }
        passwordHistory.forEach((val) => table.append($('<tr>').append($('<td>').text(val))));
        modalStatus = { passwordHistory: passwordHistory };
        $('#modalHistory').modal('show');
      }
    });
    $('#openNewPassword').on('click', () => {
      $('#modalNewPassword').modal('show');
    });
    $('#newPassword, #newPassword2').on('keyup', () => {
      const newPassword = $('#newPassword').val();
      if (newPassword) {
        if ($('#newPassword2').val() === newPassword) {
          // パスワードが一致すればボタンを押せるようにする
          $('#addNewPassword').prop('disabled', false).addClass('btn-success');
          return;
        }
      }
      $('#addNewPassword').prop('disabled', true).removeClass('btn-success');
    });
    $('#addNewPassword').on('click', () => {
      const newPassword = $('#newPassword').val();
      config.latestHash = toHash(newPassword); // 新しいパスワードのハッシュを作る
      config.cryptedHistory = cryptHistory(modalStatus.passwordHistory, newPassword); // 新しいパスワードで再暗号化する
      fs.writeFileSync('medusa.yml', yaml.safeDump(config, { flowLevel: 2 }), 'utf8');
    });
    $('#overwriteAll, #renameAll, #cancelOverwrite').on('click', (event) => {
      $('#modalOverwriteConfirm').data('buttonId', event.currentTarget.id);
    });
    $('#modalOverwriteConfirm').on('hidden.bs.modal', () => {
      const buttonId = $('#modalOverwriteConfirm').data('buttonId');
      const callback = $('#modalOverwriteConfirm').data('callback');
      callback(buttonId);
    });
  });

  function cryptHistory(passwordHistory, newPassword) {
    const crypt = function(text, password) {
      const cipher = crypto.createCipher('aes256', password + '__SALT__');
      cipher.update(text, 'utf8', 'hex');
      return cipher.final('hex');
    };
    return passwordHistory.map((val) => crypt(val, newPassword));
  }
  function decryptHistory(cryptedHistory, password) {
    const decrypt = function(text, password) {
      const decipher = crypto.createDecipher('aes256', password + '__SALT__');
      decipher.update(text, 'hex', 'utf8');
      return decipher.final('utf8');
    };
    const passwordHistory = cryptedHistory.map((val) => decrypt(val, password));
    passwordHistory.unshift(password); // 最新パスワードも含める
    return passwordHistory;
  }
  function toHash(text) {
    const hash = crypto.createHash('sha256');
    hash.update(text, 'utf8');
    return hash.digest('hex');
  }
  function zip(srcFilePath, password) {
    const _7zArgs = ['a', '-tzip', '-y', '-aoa', '-p' + password, srcFilePath + '.zip', srcFilePath];
    child_process.execFile(_7z, _7zArgs, {encoding: 'buffer'}, (e, stdout, stderr) => {
      if (e) {
        alert(iconv.decode(stderr, 'Shift_JIS')); // stderrのencodingをbufferにしておき、Shift_JISに変換してから表示する
        return;
      }
      alert('complete');
    });
  }
  function unzip(srcFilePath, destFilePath, passwordHistory) {
    (function unzipRecursively(i) {
      const destFileName = 'dest';
      const _7zArgs = ['x', '-tzip', '-p' + passwordHistory[i], '-o' + destFilePath, srcFilePath];
      const _7zProcess = child_process.spawn(_7z, _7zArgs);
      var closingMode;
      _7zProcess.stdout.on('data', (data) => {
        const text = iconv.decode(data, 'Shift_JIS');
        // 上書き確認された場合、再帰呼び出し時は必ず上書き、それ以外の場合はモーダルを出して聞く
        if (text.includes('Would you like to replace the existing file')) {
          if (i > 0) {
            _7zProcess.stdin.write('a\r\n'); // 上書き
          } else {
            $('#destFilePath').text(destFilePath);
            $('#modalOverwriteConfirm')
              .data('callback', (buttonId) => {
                if (buttonId === 'overwriteAll') {
                  _7zProcess.stdin.write('a\r\n'); // 上書き
                } else if (buttonId === 'renameAll') {
                  _7zProcess.stdin.write('u\r\n'); // リネーム
                } else {
                  _7zProcess.stdin.write('q\r\n'); // キャンセル
                }
              })
              .modal('show');
          }
        }
      });
      _7zProcess.stderr.on('data', (data) => {
        const text = iconv.decode(data, 'Shift_JIS');
        if (text.includes('Break signaled')) {
          return;
        }
        if (text.includes('Wrong password')) {
          if (i + 1 < passwordHistory.length) {
            closingMode = 'RETRY'; // リトライする場合は黙って終了する
          } else {
            closingMode = 'FAIL';
          }
          return;
        }
        throw text;
      });
      _7zProcess.on('close', (data) => {
        if (closingMode === 'RETRY') {
          unzipRecursively(i + 1);
        } else if(closingMode === 'FAIL') {
          alert((i == 0) ? 'パスワードが一致しません。' : 'パスワード履歴のどれにも一致しません。');
        } else {
          alert('解凍しました');
        }
      });
    })(0);
  }
</script>
<title>medusa</title>
</head>
<body style="padding:2em;">
  <div class="container-fluid">
    <div class="row">
      <div class="pull-left">
        <label><span class="btn btn-primary">File<input id="chooseFile" type="file" style="display:none"></span></label>
        <label><span class="btn btn-primary">Folder<input id="chooseFolder" type="file" style="display:none" webkitdirectory directory></span></label>
      </div>
      <div class="pull-right">
        <!-- 描画後にボタンの幅がピクピク調整されてしまう問題を防ぐためにwidthを明示的に指定しておく -->
        <button id="openHistory" class="btn btn-primary text-center" style="width:3em;"><span class="glyphicon glyphicon-list-alt"></span></button>
      </div>
    </div>
    <div class="row" style="height:32px;">&nbsp;</div>
    <div class="row text-right">
      <button id="close" class="btn btn-default">Close</button>
    </div>
  </div>

  <div id="modalPassword" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <table><tr><td><!-- floatだとモーダルからはみ出たのでtableレイアウトにする -->
            <div id="passwordInputGroup" class="input-group">
              <span class="input-group-addon">password</span>
              <input id="password" type="password" class="form-control" aria-describedby="basic-addon3">
            </div>
          </td><td style="padding-left:1em;">
            <button id="enterPassword" class="btn btn-primary" data-dismiss="modal">OK</button>
          </td></tr></table>
        </div>
      </div>
    </div>
  </div>

  <div id="modalHistory" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content" style="max-height:140px;overflow-y:scroll;">
        <div class="modal-body">
          <table style="width:100%; margin-bottom:1em;"><tr><td><!-- floatだとモーダルからはみ出たのでtableレイアウトにする -->
            <button id="openNewPassword" class="btn btn-danger" data-dismiss="modal">New password</button>
          </td><td class="text-right">
            <button class="btn btn-default" data-dismiss="modal">Close</button>
          </td></tr></table>
          <table id="passwordHistory" class="table table-bordered"></table>
        </div>
      </div>
    </div>
  </div>

  <div id="modalNewPassword" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <table><tr><td><!-- floatだとモーダルからはみ出たのでtableレイアウトにする -->
            <div class="input-group">
              <span class="input-group-addon">password&nbsp;&nbsp;　　　&nbsp;</span>
              <input id="newPassword" type="password" class="form-control" aria-describedby="basic-addon3"><br>
            </div>
            <div class="input-group" style="margin-top:1em;">
              <span class="input-group-addon">password (確認用)</span>
              <input id="newPassword2" type="password" class="form-control" aria-describedby="basic-addon3"><br>
            </div>
          </td><td style="padding-left:1em;vertical-align:bottom;">
            <button id="addNewPassword" class="btn" disabled="disabled" data-dismiss="modal">Add</button>
          </td></tr></table>
        </div>
      </div>
    </div>
  </div>

  <div id="modalOverwriteConfirm" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body" style="max-height:80px;max-width:400px;overflow-y:scroll;padding-bottom:0;">
          同名のファイル／フォルダが存在します：<span id="destFilePath" class="small"></span>
        </div>
        <div class="modal-footer">
          <button id="overwriteAll" class="btn btn-primary" data-dismiss="modal">全て上書き</button>
          <button id="renameAll" class="btn btn-primary" data-dismiss="modal">全て連番付与</button>
          <button id="cancelOverwrite" class="btn btn-warning" data-dismiss="modal">キャンセル</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
