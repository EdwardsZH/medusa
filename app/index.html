<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link href="../node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<script>
  window.jQuery = window.$ = require('jQuery');
  require('bootstrap');

  const electron = require('electron');
  const fs = require("fs");
  const path = require("path");
  const child_process = require('child_process');
  const iconv = require('iconv-lite');

  // Zip/Unzipアプリへのパスはとりあえず決め打ち
  const zipCommandTemplate = '"C:\\Program Files\\7-Zip\\7z.exe" a -p"${password}" -tzip "${sourcePath}.zip" "${sourcePath}"';

  $(function() {
    var modalStatus;
    $('#chooseFile, #chooseFolder').on('change', (event) => {
      modalStatus = { action: 'zip', sourcePath: event.currentTarget.files[0].path };
      event.currentTarget.value = ''; // 同じものを再度対象にしたときもchangeイベントが走るようにクリアする
      $('#modalPassword').modal('show');
    });
    $("#history").on('click', () => {
      modalStatus = { action: 'history' };
      $('#modalPassword').modal('show');
    });
    $("#settings").on('click', () => {
      alert('Will open modal to set zip/unzip application path');
    });
    $('#close').on('click', () => {
      electron.remote.getCurrentWindow().close();
    });

    // modals
    $('#password').on('keypress', (event) => {
      if (event.keyCode === 13) $('#decidePassword').click();
    });
    $('#decidePassword').on('click', () => {
      const password = $('#password').val();
      $('#password').val(''); // 入力されたパスワードはすぐにクリアして内部保持しないようにする
      if (modalStatus.action === 'zip') {
        const zipCommand = zipCommandTemplate
          .replace(/\$\{password\}/g, password)
          .replace(/\$\{sourcePath\}/g, modalStatus.sourcePath);
        child_process.exec(zipCommand, {encoding: 'buffer'}, (e, stdout, stderr) => {
          if (e) {
            alert(iconv.decode(stderr, 'Shift_JIS')); // stderrのencodingをbufferにしておき、Shift_JISに変換してから表示する
            return;
          }
          alert('complete');
        });
      } else if (modalStatus.action === 'history') {
        $('#modalHistory').modal('show');
      }
    });
    $('.modal').on('shown.bs.modal', () => {
      $(this).find('input[type="password"]:first')[0].focus();
    });
  });
</script>
<title>medusa</title>
</head>
<body style="padding:2em;">
  <div class="container-fluid">
    <div class="row">
      <div class="pull-left">
        <label><span class="btn btn-primary">File<input id="chooseFile" type="file" style="display:none"></span></label>
        <label><span class="btn btn-primary">Folder<input id="chooseFolder" type="file" style="display:none" webkitdirectory directory></span></label>
      </div>
      <div class="pull-right">
        <button id="history" class="btn btn-primary"><span class="glyphicon glyphicon glyphicon-list-alt"></span></button>
        <button id="settings" class="btn btn-primary"><span class="glyphicon glyphicon-cog"></span></button>
      </div>
    </div>
    <div class="row">&nbsp;</div>
    <div class="row">
      <button id="close" class="btn btn-default">Close</button>
    </div>
  </div>

  <div id="modalPassword" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <table><tr><td><!-- floatだとモーダルからはみ出たのでtableレイアウトにしました -->
            <div class="input-group">
              <span class="input-group-addon">password</span>
              <input id="password" type="password" class="form-control" aria-describedby="basic-addon3">
            </div>
          </td><td style="padding-left:1em;">
            <button id="decidePassword" class="btn btn-primary" data-dismiss="modal">OK</button>
          </td></tr></table>
        </div>
      </div>
    </div>
  </div>

  <div id="modalHistory" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <table style="width:100%; margin-bottom: 1em;"><tr><td><!-- floatだとモーダルからはみ出たのでtableレイアウトにしました -->
            <button id="updateHistory" class="btn btn-danger" data-dismiss="modal">Add Password</button>
          </td><td class="text-right">
            <button class="btn btn-warn" data-dismiss="modal">Close</button>
          </td></tr></table>
          <table class="table table-bordered">
            <tr><td>
              prevPassword2
            </td></tr>
            <tr><td>
              prevPassword1
          </td></tr></table>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
